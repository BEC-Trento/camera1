# -*- coding: utf-8 -*-
"""
Created on Fri Mar 25 2016

@author: SimoneSerafini

"""

import numpy as np
import time
import datetime

def readsis(filename):
    ''' Read sis files, both old version and SisV2
    Parameters
    ----------
    filename : stringa con il nome o il path relativo del file.
    Returns im1, im2, image, rawdata, stringa, block
    -------
    im1 : ndarray 2D
        first half of the image [righe 0 : height/2-1].
    im2 : ndarray 2D
        second half of the image [righe height/2 : height-1].
    image : ndarray 2D
        whole image
    rawdata : ndarray 1D
        raw data read from file
    stringa : string
        comment and datestamp of the image
    block : tuple (Bheight,Bwidth)
        Bheight : int
            y dimension of the sub-block
        Bwidth : int
            x dimension of the sub-block
    Notes
    -----
    NB all the outputs are slices of the raw data: any modifications of them will be reflected also in the linked rawdata elements
    '''
    f = open(filename, 'rb')        # open in reading and binary mode
    header = f.read(512)            # read the fixed size header: 512 bytes
    if header[0] == 48:             # 48 is ASCII code for '0': all older sis start with 0
        sisVersion = 'sis1'
        datestamp = 'we do not know'
        comment = 'nothing'
    elif header[0:5] == b'SisV2':   # SisV2 print header
        sisVersion = str(header[0:5])
        datestamp = str(header[18:37])
        comment = str(header[37:56])
    else:
        print('What fuck are you opening?')
        return True

    print("You are opening the " + sisVersion[2:-1] + " file: " + filename)
    print("It says: " + comment[1:])
    print("...and was created on " + datestamp[1:])
    f.close
    # Sometimes it gives error if the file is opened a sigle time

    f = open(filename, 'rb')                        # open in reading and binary mode
    rawdata = np.fromfile(f,'H').astype(int)
    # 'H' = uint16
    # types are listed in np.typeDict
    # put in an array the data formatted uint16 and casted to int
    ''' NB fundamental to cast to int:
        unsigned short gives overflow '''
    f.close

    # Dimension of the whole image
    width=rawdata[6]  # N cols
    height=rawdata[5] # N rows

    # Dimension of the sub-blocks
    Bwidth=rawdata[8]  # N subcols
    Bheight=rawdata[7] # N subrows

    # Reading the images
    image = rawdata[-width*height:]
    image.resize(height,width)

    # defines the two images in the sis
    im0 = image[:height//2, :]
    im1 = image[height//2:, :]

    stringa = sisVersion[1:-1] + ' ' + datestamp[2:-1] + ' ' + comment[2:]
    block = (Bheight,Bwidth)

    return im0, im1, image, rawdata, stringa , block

def sis_write(self, image, filename, Bheight, Bwidth, stamp):
        """
        Low-level interaction with the sis file for writing it.
        Writes the whole image, with the unused part filled with zeros.

        Args:
            image (np.array): the 2d-array that must be writed after conversion
            to 16-bit unsigned-integers (must be already normalized)
            filename (string): sis filename
            Bheight (int): the y dimension of the eventual block
            Bwidth (int): the x dimension of the eventual block
            stamp (string): a string to describe who, why and what you want
        """
        #keep the double-image convention for sis files, filling the unused
        #with zeros
        if self == 0:
            image = np.concatenate((image, np.zeros_like(image)))
        elif self == 1:
            image = np.concatenate((np.zeros_like(image), image))

        with open(str(filename), 'w+b') as fid:
            # Write here SisV2 + other 4 free bytes
            head = 'SisV2' + '.' + '0'*4
            fid.write(head.encode())

            # This is OK
            height, width = image.shape
            size = np.array([height, width], dtype=np.uint16)
            size.tofile(fid)

            # Here we put 2*2 more bytes with the sub-block dimension
            Bsize = np.array([Bheight, Bwidth], dtype=np.uint16)
            Bsize.tofile(fid)

            # Also a timestamp
            ts = time.time()
            phead = datetime.datetime.fromtimestamp(ts).strftime('%Y-%m-%d %H:%M:%S')
            fid.write(phead.encode())

            # More: descriptive stamp
            fid.write(stamp.encode())
            freeHead = '0'*(475-len(stamp))
            fid.write(freeHead.encode())

            image.astype(np.uint16).tofile(fid)
